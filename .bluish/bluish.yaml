
var:
  PROJECT_VERSION: "0.0.2"

jobs:
  publish:
    runs_on: docker://python:3.12-alpine
    steps:
      - run: |
          apk update && apk add jq curl git

      - uses: git/checkout
        with:
          repository: https://github.com/luismedel/bluish

      - name: Download latest published version
        run: |
          curl https://pypi.org/pypi/bluish/json | jq -r .info.version
        set:
          workflow.var.PYPI_VERSION: ${{ output }}

      - name: Check if we got a valid PYPI_VERSION
        run: |
          if [ "${{ var.PYPI_VERSION }}" == "" ]; then
            false
          fi

      - name: Check if upload is needed
        run: |
          if [ "${{ var.PROJECT_VERSION }}" == "${{ var.PYPI_VERSION }}" ]; then
            echo "Upload not needed. Already on ${{ var.PYPI_VERSION }}"
            false
          fi

      - name: Update pyproject.toml
        uses: core/expand-template
        with:
          input_file: ./templates/pyproject.toml.template
          output_file: ./pyproject.toml

      - name: Update src/bluish/__main__.py
        uses: core/expand-template
        with:
          input_file: ./templates/__main__.py.template
          output_file: ./src/bluish/__main__.py

      - name: Build project
        run: |
          python -m pip install --upgrade build
          python -m build

      - name: Prepare credentials
        uses: core/upload-file
        with:
          source_file: ~/.pypirc
          destination_file: ~/.pypirc

      - name: Deploy to Pypi
        run: |
          python -m pip install --upgrade twine
          python -m twine upload dist/*
